<!DOCTYPE html>
<html lang="en-UK">
<head>
<title>Balancity editor</title>
<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
<link rel ="stylesheet" href="StyleBalancity.css" />

</head>
<body>

<h2>Open Street Map Routing</h2>
<p>This page shows balanced routing using Open Street Map and Graphhopper.</p>

<div id="map"></div>

<div id="trafficLayer">
<button id="loadJsonFile" type="button" onclick="loadTrafficJSON()"> Traffic </button>
<p id="time"></p>
<button id="loadOD" type="button" onclick="loadOD()"> Origin-Destination </button> 
</div>

<div id="forms">
<form>
<button id="buttonA" type="button" onclick="markerAClicked()"> A </button> lat:	<input id="alat" type="text" name ="alat">
long:	<input id="alng" type="text" name = "alng">
<br>
<button id="buttonB" type="button" onclick="markerBClicked()"> B </button> lat:	<input id="blat" type="text" name="blat">
long:	<input id="blng" type="text" name="blng"><br>
<input type="submit" value="Route">
</form>
</div>


<script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
<script src="https://rawgithub.com/mpetazzoni/leaflet-gpx/master/gpx.js"></script>
<script src="//code.jquery.com/jquery-1.11.1.min.js"></script>
<script> 

	var map = L.map('map').setView([52.37162, 4.90505], 12);
	L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpandmbXliNDBjZWd2M2x6bDk3c2ZtOTkifQ._QA7i5Mpkd_m30IGElHziw', 	{
			maxZoom: 18,
			attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
				'<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
				'Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
			id: 'mapbox.streets'
		}).addTo(map);
		
		
		var startIcon = L.icon({
			iconUrl: 'img/pin-icon-start.png',
			shadowUrl: 'img/pin-shadow.png',
			
			iconSize:		[30,30],
			shadowSize:		[50,64]
		});
		
		var endIcon = L.icon({
			iconUrl: 'img/pin-icon-end.png',
			shadowUrl: 'img/pin-shadow.png',
			
			iconSize:		[30,30],
			shadowSize:		[50,64],
			iconAnchor: 	[22,94],
			shadowAnchor:	[4,62],
			popupAnchor:	[-3,-76]
		});
		
		var AGenerated = false;
		var BGenerated = false;
		var marker_index = 0;
		
		function markerAClicked()
		{
			if(AGenerated){
				map.removeLayer(markerA);
				AGenerated = false;
			}
			
			//Place marker
			marker_index = 0;
		}
		
		function markerBClicked()
		{
			if(BGenerated)
			{
				map.removeLayer(markerB);
				BGenerated = false;
			}
			
			//Place marker
			marker_index = 1;
		}
		
		function onMapClick(e) 
		{
		
			if(!AGenerated&&marker_index==0)
			{
				markerA = new L.marker(e.latlng, {draggable:'true'});
				AGenerated = true;			
				document.getElementById('alng').value = e.latlng.lng;
				document.getElementById('alat').value= e.latlng.lat;
				markerA.addTo(map);
				marker_index=1;
			}
			else
			{
				if(!BGenerated&&marker_index==1){
					markerB = new L.marker(e.latlng);
					BGenerated = true;
					document.getElementById('blng').value = e.latlng.lng;
					document.getElementById('blat').value= e.latlng.lat;			
					markerB.addTo(map);
					marker_index=0;
				}
			}
		}

		
		map.on('click', onMapClick);
		/*for(i=0;i <1000;i++){
			var gpx = "http://localhost/testfiles/test" + i+ ".gpx";		
			new L.GPX(gpx,{async:true}).on('loaded',function(e) {
			map.fitBounds(e.target.getBounds());
			}).addTo(map);		
			}*/
			
	function loadTrafficJSON()
	{
		clearMap();
		jQuery.getJSON('orderedtraffic.json', function(data){
			var maxTraffic = 0;
			for(j=0;j<data.traffic.length;j++){
				(function(j) {
					setTimeout(function() 
					{
						clearMap();
						for(i=0; i<data.traffic[j].time.length; i++)
						{
							var hours = Math.floor(data.traffic[j].time[i].time / 60);
							var minutes = data.traffic[j].time[i].time %60;
							if(minutes<10){
								document.getElementById("time").innerHTML = hours.toFixed(0) + ":0"+minutes.toFixed(0);
							}
							else{
								document.getElementById("time").innerHTML = hours.toFixed(0) + ":"+minutes.toFixed(0);
							}
							var pointA = new L.LatLng(data.traffic[j].time[i].latFrom, data.traffic[j].time[i].lonFrom);
							var pointB = new L.LatLng(data.traffic[j].time[i].latTo, data.traffic[j].time[i].lonTo);
							var pointList = [pointA, pointB];
							if(data.traffic[j].time[i].trafficCount > maxTraffic){
								maxTraffic = data.traffic[j].time[i].trafficCount;
							}
								if(data.traffic[j].time[i].trafficCount>0.6)
								{
									if(data.traffic[j].time[i].trafficCount >0.5){
										if(data.traffic[j].time[i].trafficCount <2)
										{
											var firstpolyline = new L.Polyline(pointList, {
											color: 'green',
											weight: 7,
											opacity: 1,
											smoothFactor: 1

											});
											firstpolyline.addTo(map);
										}else if(data.traffic[j].time[i].trafficCount<3)
										{
											var firstpolyline = new L.Polyline(pointList, {
											color: 'orange',
											weight: 7,
											opacity: 1,
											smoothFactor: 1

											});
											firstpolyline.addTo(map);
										}else
										{
											var firstpolyline = new L.Polyline(pointList, {
											color: 'red',
											weight: 7,
											opacity: 1,
											smoothFactor: 1

											});
											firstpolyline.addTo(map);
										}
									}
								}
						}
								console.log('maxTraffic: '+maxTraffic);
					}, 300*j);
				})(j);
			}

		});
	}
	
	function loadOD()
	{		
		jQuery.get('testfiles/test/instance.txt', function(data){
			var entries = data.split('\n');
			console.log(entries.length);
			for(i=0; i<1000; i++){
				var point = entries[i].split(';');
				var pointco = point[0].split(',');
				var markerS = L.marker([pointco[0],pointco[1]],{icon: startIcon}).addTo(map);
				var pointco = point[1].split(',');
				var markerE = L.marker([pointco[0],pointco[1]],{icon:endIcon}).addTo(map);
			}
		});
	}
	
	function clearMap() {
    for(i in map._layers) {
        if(map._layers[i]._path != undefined) {
            try {
                map.removeLayer(map._layers[i]);
            }
            catch(e) {
                console.log("problem with " + e + map._layers[i]);
            }
        }
    }
}
	
</script>

</body>
</html>
