<!DOCTYPE html>
<html lang="en-UK">
<head>
<title>Balancity editor</title>
<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
<link rel ="stylesheet" href="StyleBalancity.css" />

</head>
<body onload = "pageLoad()">

<h2>Open Street Map Routing</h2>
<p>This page shows balanced routing using Open Street Map and Graphhopper.</p>

<div id="map"></div>

<div id="trafficLayer">
<div id="slider">
<button id="decrement" type = "button" onclick="decrement();loadTrafficJSON()"> - </button>
<form>
<input type="range" name="TrafficTime" id="TrafficTime" onchange = "loadTrafficJSON()" oninput = "loadTrafficJSON()" value="0" min="0" max="getNumberOfTimes()" step = "1">
</form>
<button id="increment" type = "button" onclick="increment();loadTrafficJSON()"> + </button>
</div>
<!--<button id="loadJsonFile" type="button" onclick="loadTrafficJSON()"> Traffic </button>-->
<button id="clearLayers" type="button" onclick="clearMap()"> Clear Layers </button>
<p id="time"></p>
<button id="loadOD" type="button" onclick="loadOD()"> Origin-Destination </button> 
<BR>
GPX: <input type="checkbox" onclick="showGPS()" id="gpxCheckBox">
</div>


<script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
<script src="gpx.js"></script>
<script src="//code.jquery.com/jquery-1.11.1.min.js"></script>
<script> 

	var times = [];

	function pageLoad()
	{
		setNumberOfTimes();
	}

	function increment()
	{
		document.getElementById("TrafficTime").stepUp(1)
	}
	
	function decrement()
	{
		document.getElementById("TrafficTime").stepDown(1)
	}

	var map = L.map('map').setView([52.37162, 4.90505], 12);
	L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoicGRlZ29mZmF1IiwiYSI6ImNpcGZ0bmt1bTAwMGd2Nm5scG03YzNnanMifQ.KxQDEZzmLCdnJa3ZY_DURg', 	{
			maxZoom: 18,
			attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
				'<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
				'Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
			id: 'mapbox.streets'
		}).addTo(map);
		
		
		var startIcon = L.icon({
			iconUrl: 'img/pin-icon-start.png',
			shadowUrl: 'img/pin-shadow.png',
			
			iconSize:		[30,30],
			shadowSize:		[50,64]
		});
		
		var endIcon = L.icon({
			iconUrl: 'img/pin-icon-end.png',
			shadowUrl: 'img/pin-shadow.png',
			
			iconSize:		[30,30],
			shadowSize:		[50,64],
			iconAnchor: 	[22,94],
			shadowAnchor:	[4,62],
			popupAnchor:	[-3,-76]
		});

		var gpxLayerGroup = new L.LayerGroup();
		
		function showGPS()
		{
			if(document.getElementById("gpxCheckBox").checked)
			{
				for(i=0;i <100;i=i+1)
				{
					var gpx = "http://localhost/testfiles/test" + i+ ".gpx";		
					var GPX = new L.GPX(gpx,{async:true}).on('loaded',function(e) {
					map.fitBounds(e.target.getBounds());
					});
					gpxLayerGroup.addLayer(GPX);
					gpxLayerGroup.addTo(map);
				}
			}
			else
			{
				gpxLayerGroup.clearLayers();
			}
			
		}
		
	function setNumberOfTimes()
	{	
		jQuery.getJSON('orderedTraffictimes.json', function(data){
			document.getElementById("TrafficTime").max = data.times.length - 1;
			for(i=0;i<data.times.length;i++)
			{
				times[i] = data.times[i].time;
			}
		});

	}
	
	function loadTrafficJSON()
	{
		clearMap();
		var j = times[document.getElementById("TrafficTime").value];
		jQuery.getJSON('orderedtraffic'+j+'.json', function(data)
		{
			var maxTraffic = 0;
			for(i=0; i<data.traffic.length; i++)
			{
				var hours = Math.floor(data.traffic[i].time / 60);
				var minutes = data.traffic[i].time %60;
				if(minutes<10)
				{
					document.getElementById("time").innerHTML = hours.toFixed(0) + ":0"+minutes.toFixed(0);
				}
				else
				{
					document.getElementById("time").innerHTML = hours.toFixed(0) + ":"+minutes.toFixed(0);
				}
				var pointA = new L.LatLng(data.traffic[i].latFrom, data.traffic[i].lonFrom);
				var pointB = new L.LatLng(data.traffic[i].latTo, data.traffic[i].lonTo);
				var pointList = [pointA, pointB];
				
				if(data.traffic[i].trafficCount > maxTraffic)
				{
					maxTraffic = data.traffic[i].trafficCount;
				}
				if(data.traffic[i].trafficCount>0.6)
				{
					if(data.traffic[i].trafficCount >0.5)
					{
						if(data.traffic[i].trafficCount <2)
						{
							var firstpolyline = new L.Polyline(pointList, 
							{
								color: 'green',
								weight: 7,
								opacity: 1,
								smoothFactor: 1
							});
							firstpolyline.addTo(map);
						}else if(data.traffic[i].trafficCount<3)
						{
							var firstpolyline = new L.Polyline(pointList, 
							{
								color: 'orange',
								weight: 7,
								opacity: 1,
								smoothFactor: 1
							});
							firstpolyline.addTo(map);
						}else
						{
							var firstpolyline = new L.Polyline(pointList, 
							{
								color: 'red',
								weight: 7,
								opacity: 1,
								smoothFactor: 1
							});
							firstpolyline.addTo(map);
						}
					}
				}
			}
				console.log('maxTraffic: '+maxTraffic);
		});
	}
	
	function loadOD()
	{		
		jQuery.get('testfiles/test/instance.txt', function(data){
			var entries = data.split('\n');
			console.log(entries.length);
			for(i=0; i<1000; i++){
				var point = entries[i].split(';');
				var pointco = point[0].split(',');
				var markerS = L.marker([pointco[0],pointco[1]],{icon: startIcon}).addTo(map);
				var pointco = point[1].split(',');
				var markerE = L.marker([pointco[0],pointco[1]],{icon:endIcon}).addTo(map);
			}
		});
	}
	
	function clearMap() {
    for(i in map._layers) {
        if(map._layers[i]._path != undefined) {
            try {
                map.removeLayer(map._layers[i]);
            }
            catch(e) {
                console.log("problem with " + e + map._layers[i]);
            }
        }
    }
}
	
</script>

</body>
</html>
